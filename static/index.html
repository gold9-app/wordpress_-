<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>메디셜 블로그 발행</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a73e8">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', -apple-system, sans-serif;
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #1a73e8, #0d47a1);
      color: white;
      padding: 24px 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .header h1 { font-size: 22px; font-weight: 600; }
    .header p { font-size: 13px; opacity: 0.8; margin-top: 4px; }
    .container { max-width: 600px; margin: 24px auto; padding: 0 16px; }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .card-body { padding: 24px; }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #333;
    }
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
    }
    .form-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-input:focus { border-color: #1a73e8; }
    .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .form-select:focus { border-color: #1a73e8; }
    .form-row {
      display: flex;
      gap: 12px;
    }
    .form-row .form-group { flex: 1; }
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 28px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafbfc;
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: #1a73e8;
      background: #e8f0fe;
    }
    .drop-zone.has-file {
      border-color: #34a853;
      background: #e6f4ea;
    }
    .drop-zone-icon { font-size: 28px; margin-bottom: 6px; }
    .drop-zone-text { font-size: 13px; color: #666; }
    .drop-zone-file { font-size: 13px; color: #1a73e8; font-weight: 500; margin-top: 4px; }
    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-publish {
      background: #1a73e8;
      color: white;
    }
    .btn-publish:hover:not(:disabled) { background: #1557b0; }
    .btn-draft {
      background: #f1f3f4;
      color: #333;
    }
    .btn-draft:hover:not(:disabled) { background: #e0e2e4; }
    .btn-login {
      width: 100%;
      background: #1a73e8;
      color: white;
      padding: 12px;
      font-size: 15px;
    }
    .btn-login:hover:not(:disabled) { background: #1557b0; }
    .btn-group { display: flex; gap: 10px; }
    .status-msg {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 13px;
      display: none;
    }
    .status-ok { display: block; background: #e8f5e9; color: #2e7d32; }
    .status-err { display: block; background: #fce4ec; color: #c62828; }
    .status-loading { display: block; background: #e3f2fd; color: #1565c0; }
    .spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid #1a73e8;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .result-link {
      color: #1a73e8;
      text-decoration: none;
      font-weight: 500;
      word-break: break-all;
    }
    .result-link:hover { text-decoration: underline; }
    .hidden { display: none !important; }
    .reset-btn {
      background: none;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
      color: #666;
      margin-top: 12px;
    }
    .reset-btn:hover { background: #f5f5f5; }
    .seo-info {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>메디셜 블로그 자동 발행</h1>
    <p>HTML + 이미지를 업로드하여 WordPress에 발행</p>
  </div>

  <!-- 비밀번호 화면 -->
  <div class="container" id="loginScreen">
    <div class="card">
      <div class="card-body">
        <div class="card-title">비밀번호 입력</div>
        <div class="form-group">
          <input type="password" class="form-input" id="passwordInput"
                 placeholder="비밀번호를 입력하세요" autocomplete="current-password">
        </div>
        <button class="btn btn-login" onclick="login()">로그인</button>
        <div class="status-msg" id="loginStatus"></div>
      </div>
    </div>
  </div>

  <!-- 발행 화면 -->
  <div class="container hidden" id="publishScreen">
    <div class="card">
      <div class="card-body">
        <div class="card-title">글 발행</div>

        <!-- 제목 -->
        <div class="form-group">
          <label class="form-label">글 제목</label>
          <input type="text" class="form-input" id="titleInput"
                 placeholder="예: 계란에 대해 잘못 알려진 6가지 상식">
        </div>

        <!-- 작성자 / 카테고리 -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">작성자</label>
            <select class="form-select" id="authorSelect" onchange="onAuthorChange()">
              <option value="">불러오는 중...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">카테고리</label>
            <select class="form-select" id="categorySelect">
              <option value="">불러오는 중...</option>
            </select>
          </div>
        </div>

        <!-- 외부 링크 (응석 김 제외) -->
        <div class="form-group hidden" id="externalLinkGroup">
          <label class="form-label">외부 링크 (선택사항)</label>
          <input type="text" class="form-input" id="externalLinkInput"
                 placeholder="예: https://instagram.com/yourname">
          <div style="font-size:11px; color:#888; margin-top:4px;">글 하단에 링크가 삽입됩니다</div>
        </div>

        <!-- HTML 파일 -->
        <div class="form-group">
          <label class="form-label">HTML 파일</label>
          <div class="drop-zone" id="htmlDrop" onclick="document.getElementById('htmlFileInput').click()">
            <div class="drop-zone-icon">&#128196;</div>
            <div class="drop-zone-text">클릭 또는 드래그하여 HTML 파일 업로드</div>
            <div class="drop-zone-file" id="htmlFileName"></div>
          </div>
          <input type="file" id="htmlFileInput" accept=".html,.htm" style="display:none">
        </div>

        <!-- 이미지 파일 -->
        <div class="form-group">
          <label class="form-label">대표 이미지</label>
          <div class="drop-zone" id="imageDrop" onclick="document.getElementById('imageFileInput').click()">
            <div class="drop-zone-icon">&#128247;</div>
            <div class="drop-zone-text">클릭 또는 드래그하여 이미지 업로드</div>
            <div class="drop-zone-file" id="imageFileName"></div>
          </div>
          <input type="file" id="imageFileInput" accept="image/*" style="display:none">
        </div>

        <!-- 버튼 -->
        <div class="btn-group">
          <button class="btn btn-publish" id="btnPublish" onclick="publish('publish')">발행하기</button>
          <button class="btn btn-draft" id="btnDraft" onclick="publish('draft')">임시글 저장</button>
        </div>

        <div class="status-msg" id="publishStatus"></div>
      </div>
    </div>

    <!-- 발행 완료 후 새 글 작성 버튼 -->
    <div class="hidden" id="resetArea" style="text-align:center;">
      <button class="reset-btn" onclick="resetForm()">새 글 작성</button>
    </div>
  </div>

  <script>
    let htmlFile = null;
    let imageFile = null;

    // --- 비밀번호 / 인증 ---
    function getPassword() {
      return sessionStorage.getItem('app_pw') || '';
    }

    async function login() {
      const pw = document.getElementById('passwordInput').value;
      const statusEl = document.getElementById('loginStatus');
      statusEl.className = 'status-msg status-loading';
      statusEl.innerHTML = '<span class="spinner"></span> 확인 중...';

      try {
        const resp = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pw }),
        });
        const data = await resp.json();
        if (data.ok) {
          sessionStorage.setItem('app_pw', pw);
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('publishScreen').classList.remove('hidden');
          loadOptions();
        } else {
          statusEl.className = 'status-msg status-err';
          statusEl.textContent = data.error || '로그인 실패';
        }
      } catch (e) {
        statusEl.className = 'status-msg status-err';
        statusEl.textContent = '서버 연결 실패';
      }
    }

    // 엔터키로 로그인
    document.getElementById('passwordInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') login();
    });

    // 이미 로그인된 경우 자동 전환
    if (getPassword()) {
      fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: getPassword() }),
      }).then(r => r.json()).then(d => {
        if (d.ok) {
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('publishScreen').classList.remove('hidden');
          loadOptions();
        }
      }).catch(() => {});
    }

    // --- 옵션 로드 (작성자/카테고리) ---
    async function loadOptions() {
      try {
        const resp = await fetch('/api/options', {
          headers: { 'X-App-Password': getPassword() }
        });
        const data = await resp.json();
        if (!data.ok) return;

        const authorSel = document.getElementById('authorSelect');
        const catSel = document.getElementById('categorySelect');

        authorSel.innerHTML = data.authors.map(a =>
          `<option value="${a.id}" ${a.id === data.defaults.author_id ? 'selected' : ''}>${a.name}</option>`
        ).join('');

        catSel.innerHTML = data.categories.map(c =>
          `<option value="${c.id}" ${c.id === data.defaults.category_id ? 'selected' : ''}>${c.name}</option>`
        ).join('');

        onAuthorChange();
      } catch (e) {
        console.error('옵션 로드 실패', e);
      }
    }

    function onAuthorChange() {
      const authorId = document.getElementById('authorSelect').value;
      const linkGroup = document.getElementById('externalLinkGroup');
      // 응석 김(ID=4)이면 숨김, 다른 작성자면 표시
      if (authorId === '4') {
        linkGroup.classList.add('hidden');
        document.getElementById('externalLinkInput').value = '';
      } else {
        linkGroup.classList.remove('hidden');
      }
    }

    // --- 드래그 & 드롭 ---
    function setupDropZone(dropId, fileInputId, fileNameId, onFile) {
      const dropZone = document.getElementById(dropId);
      const fileInput = document.getElementById(fileInputId);
      const fileName = document.getElementById(fileNameId);

      ['dragenter', 'dragover'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
          e.preventDefault();
          dropZone.classList.add('dragover');
        });
      });
      ['dragleave', 'drop'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
        });
      });

      dropZone.addEventListener('drop', e => {
        const file = e.dataTransfer.files[0];
        if (file) {
          onFile(file);
          fileName.textContent = file.name;
          dropZone.classList.add('has-file');
        }
      });

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
          onFile(file);
          fileName.textContent = file.name;
          dropZone.classList.add('has-file');
        }
      });
    }

    setupDropZone('htmlDrop', 'htmlFileInput', 'htmlFileName', f => { htmlFile = f; });
    setupDropZone('imageDrop', 'imageFileInput', 'imageFileName', f => { imageFile = f; });

    // --- 발행 ---
    async function publish(status) {
      const title = document.getElementById('titleInput').value.trim();
      const statusEl = document.getElementById('publishStatus');
      const btnP = document.getElementById('btnPublish');
      const btnD = document.getElementById('btnDraft');

      if (!title) { alert('제목을 입력해주세요.'); return; }
      if (!htmlFile) { alert('HTML 파일을 업로드해주세요.'); return; }
      if (!imageFile) { alert('이미지 파일을 업로드해주세요.'); return; }

      btnP.disabled = true;
      btnD.disabled = true;
      statusEl.className = 'status-msg status-loading';
      statusEl.innerHTML = '<span class="spinner"></span> WordPress에 발행 중...';

      const authorId = document.getElementById('authorSelect').value;
      const categoryId = document.getElementById('categorySelect').value;
      const externalLink = document.getElementById('externalLinkInput').value.trim();

      const formData = new FormData();
      formData.append('title', title);
      formData.append('status', status);
      formData.append('author_id', authorId);
      formData.append('category_id', categoryId);
      formData.append('external_link', externalLink);
      formData.append('html_file', htmlFile);
      formData.append('image_file', imageFile);

      try {
        const resp = await fetch('/api/publish', {
          method: 'POST',
          headers: { 'X-App-Password': getPassword() },
          body: formData,
        });
        const data = await resp.json();

        if (data.ok) {
          let html = '발행 완료! <a class="result-link" href="' + data.url + '" target="_blank">' + data.url + '</a>';
          if (data.seo) {
            html += '<div class="seo-info">';
            html += 'Focus Keyword: ' + data.seo.focus_keyword + '<br>';
            html += 'SEO 제목: ' + data.seo.seo_title + '<br>';
            html += '슬러그: ' + data.seo.slug;
            html += '</div>';
          }
          statusEl.className = 'status-msg status-ok';
          statusEl.innerHTML = html;
          document.getElementById('resetArea').classList.remove('hidden');
        } else {
          statusEl.className = 'status-msg status-err';
          statusEl.textContent = data.error;
          btnP.disabled = false;
          btnD.disabled = false;
        }
      } catch (e) {
        statusEl.className = 'status-msg status-err';
        statusEl.textContent = '서버 오류';
        btnP.disabled = false;
        btnD.disabled = false;
      }
    }

    function resetForm() {
      document.getElementById('titleInput').value = '';
      htmlFile = null;
      imageFile = null;
      document.getElementById('htmlFileName').textContent = '';
      document.getElementById('imageFileName').textContent = '';
      document.getElementById('htmlDrop').classList.remove('has-file');
      document.getElementById('imageDrop').classList.remove('has-file');
      document.getElementById('htmlFileInput').value = '';
      document.getElementById('imageFileInput').value = '';
      document.getElementById('publishStatus').className = 'status-msg';
      document.getElementById('publishStatus').innerHTML = '';
      document.getElementById('btnPublish').disabled = false;
      document.getElementById('btnDraft').disabled = false;
      document.getElementById('resetArea').classList.add('hidden');
      document.getElementById('externalLinkInput').value = '';
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
